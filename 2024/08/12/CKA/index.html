<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>CKA考试 | 颗粒的运维手册</title><meta name="author" content="keli"><meta name="copyright" content="keli"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="1、权限控制 RBAC设置配置环境：[candidate@node-1] $ kubectl config use-context k8sContext为部署流水线创建一个新的 ClusterRole 并将其绑定到范围为特定的 namespace 的特定 ServiceAccount。Task创建一个名为deployment-clusterrole 且仅允许创建以下资源类型的新 ClusterRo">
<meta property="og:type" content="article">
<meta property="og:title" content="CKA考试">
<meta property="og:url" content="http://example.com/2024/08/12/CKA/index.html">
<meta property="og:site_name" content="颗粒的运维手册">
<meta property="og:description" content="1、权限控制 RBAC设置配置环境：[candidate@node-1] $ kubectl config use-context k8sContext为部署流水线创建一个新的 ClusterRole 并将其绑定到范围为特定的 namespace 的特定 ServiceAccount。Task创建一个名为deployment-clusterrole 且仅允许创建以下资源类型的新 ClusterRo">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/avatar.png">
<meta property="article:published_time" content="2024-08-12T02:26:27.998Z">
<meta property="article:modified_time" content="2024-04-28T06:04:34.000Z">
<meta property="article:author" content="keli">
<meta property="article:tag" content="kubernetes考试">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/avatar.png"><link rel="shortcut icon" href="/img/icon.png"><link rel="canonical" href="http://example.com/2024/08/12/CKA/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'CKA考试',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-04-28 14:04:34'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">19</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">17</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="颗粒的运维手册"><span class="site-name">颗粒的运维手册</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">CKA考试</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-08-12T02:26:27.998Z" title="发表于 2024-08-12 10:26:27">2024-08-12</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-04-28T06:04:34.000Z" title="更新于 2024-04-28 14:04:34">2024-04-28</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/kubernetes/">kubernetes</a></span></div><div class="meta-secondline"></div></div></div><article class="post-content" id="article-container"><h3 id="1、权限控制-RBAC"><a href="#1、权限控制-RBAC" class="headerlink" title="1、权限控制 RBAC"></a>1、权限控制 RBAC</h3><p>设置配置环境：<br>[candidate@node-1] $ kubectl config use-context k8s<br><strong>Context</strong><br>为部署流水线创建一个新的 <strong>ClusterRole</strong> 并将其绑定到范围为特定的 namespace 的特定 <strong>ServiceAccount</strong>。<br><strong>Task</strong><br>创建一个名为<strong>deployment-clusterrole</strong> 且仅允许创建以下资源类型的新 <strong>ClusterRole</strong>：<br><strong>Deployment</strong><br><strong>StatefulSet</strong><br><strong>DaemonSet</strong><br>在现有的 namespace <strong>app-team1</strong> 中创建一个名为 <strong>cicd-token</strong> 的新 ServiceAccount。<br>限于 namespace <strong>app-team1</strong> 中，将新的 ClusterRole <strong>deployment-clusterrole</strong> 绑定到新的 ServiceAccount <strong>cicd-token</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrole -h</span><br><span class="line">kubectl create rolebinding -h</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrole deployment-clusterrole --verb=create --resource=deployments,statefulsets,daemonsets</span><br><span class="line"></span><br><span class="line">kubectl -n app-team1 create serviceaccount cicd-token</span><br><span class="line"></span><br><span class="line"># 题目中写了“限于 namespace app-team1 中”，则创建 rolebinding。没有写的话，则创建 clusterrolebinding。</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n app-team1 create rolebinding cicd-token-rolebinding --clusterrole=deployment-clusterrole --serviceaccount=app-team1:cicd-token</span><br><span class="line"></span><br><span class="line"># rolebinding 后面的名字 cicd-token-rolebinding 随便起的，因为题目中没有要求，如果题目中有要求，就不能随便起了。</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 检查（考试时，可以不检查的）</span><br><span class="line">kubectl -n app-team1 describe rolebinding cicd-token-rolebinding</span><br></pre></td></tr></table></figure>
<h3 id="2、查看-pod-的-CPU"><a href="#2、查看-pod-的-CPU" class="headerlink" title="2、查看 pod 的 CPU"></a>2、查看 pod 的 CPU</h3><p>设置配置环境：<br>[candidate@node-1] $ kubectl config use-context k8s<br><strong>Task</strong><br>通过 pod label <strong>name&#x3D;cpu-loader</strong>，找到运行时占用大量 CPU 的 pod，<br>并将占用 CPU 最高的 pod 名称写入文件 <strong>&#x2F;opt&#x2F;KUTR000401&#x2F;KUTR00401.txt</strong>（已存在）。<br>kubectl top pod -h</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 查看 pod 名称 -A 是所有 namespace</span><br><span class="line">kubectl top pod -l name=cpu-loader --sort-by=cpu -A</span><br><span class="line"></span><br><span class="line"># 将 cpu 占用最多的 pod 的 name 写入/opt/test1.txt 文件</span><br><span class="line">echo &quot;查出来的 Pod Name&quot; &gt; /opt/KUTR000401/KUTR00401.txt</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">检查</span><br><span class="line">cat /opt/KUTR000401/KUTR00401.txt</span><br></pre></td></tr></table></figure>
<h3 id="3、配置网络策略-NetworkPolicy"><a href="#3、配置网络策略-NetworkPolicy" class="headerlink" title="3、配置网络策略 NetworkPolicy"></a>3、配置网络策略 NetworkPolicy</h3><p>设置配置环境：<br>[candidate@node-1] $ kubectl config use-context hk8s<br><strong>Task</strong><br>在现有的 namespace my-app 中创建一个名为 allow-port-from-namespace 的新 NetworkPolicy。<br>确保新的 NetworkPolicy 允许 namespace echo 中的 Pods 连接到 namespace my-app 中的 Pods 的 9000 端口。<br>进一步确保新的 NetworkPolicy：<br>不允许对没有在监听 端口 9000 的 Pods 的访问<br>不允许非来自 namespace echo 中的 Pods 的访问<br>双重否定就是肯定，所以最后两句话的意思就是： 仅允许端口为 9000 的 pod 方法。 仅允许 echo 命名空间中的 pod 访问。<br>Concepts → Services, Load Balancing, and Networking → Network Policies</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">查看所有 ns 的标签 label</span><br><span class="line">kubectl get ns --show-labels</span><br><span class="line">如果访问者的 namespace 没有标签 label，则需要手动打一个。如果有一个独特的标签 label，则也可以直接使用。</span><br><span class="line">kubectl label ns echo project=echo</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">vim networkpolicy.yaml</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: NetworkPolicy</span><br><span class="line">metadata:</span><br><span class="line">  name: allow-port-from-namespace</span><br><span class="line">  namespace: my-app </span><br><span class="line">spec:</span><br><span class="line">  podSelector: #这两行必须要写，或者也可以写成一行为 podSelector: &#123;&#125;</span><br><span class="line">    matchLabels: &#123;&#125; # 注意 matchLabels:与&#123;&#125;之间有一个空格</span><br><span class="line">  policyTypes:</span><br><span class="line">  - Ingress #策略影响入栈流量</span><br><span class="line">  ingress:</span><br><span class="line">  - from: #允许流量的来源</span><br><span class="line">    - namespaceSelector:</span><br><span class="line">        matchLabels:</span><br><span class="line">          project: echo #访问者的命名空间的标签 label</span><br><span class="line"> #- podSelector: &#123;&#125; #注意，这个不写。如果 ingress 里也写了- podSelector: &#123;&#125;，则会导致 my-app 中的 pod 可以访问 my-app 中 pod 的 9000 了，这样不</span><br><span class="line">满足题目要求不允许非来自 namespace echo 中的 Pods 的访问。</span><br><span class="line">   ports:</span><br><span class="line">   - protocol: TCP</span><br><span class="line">   port: 9000 #被访问者公开的端口</span><br><span class="line"></span><br><span class="line">创建</span><br><span class="line">kubectl apply -f networkpolicy.yaml</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">检查</span><br><span class="line">kubectl describe networkpolicy -n my-app</span><br></pre></td></tr></table></figure>
<h3 id="4、暴露服务-service"><a href="#4、暴露服务-service" class="headerlink" title="4、暴露服务 service"></a>4、暴露服务 service</h3><p>设置配置环境：<br>[candidate@node-1] $ kubectl config use-context k8s<br><strong>Task</strong><br>请重新配置现有的 deployment <strong>front-end</strong> 以及添加名为 <strong>http</strong> 的端口规范来公开现有容器 <strong>nginx</strong> 的端口 <strong>80&#x2F;tcp</strong>。<br>创建一个名为 <strong>front-end-svc</strong> 的新 service，以公开容器端口 <strong>http</strong>。<br>配置此 service，以通过各个 Pod 所在的节点上的 <strong>NodePort</strong> 来公开他们。<br>考点：将现有的 deploy 暴露成 nodeport 的 service。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">参考链接 </span><br><span class="line">https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/deployment/</span><br></pre></td></tr></table></figure>
<p><strong>解答</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">检查 deployment 信息，并记录 SELECTOR 的 Lable 标签，这里是 app=front-end</span><br><span class="line">kubectl get deployment front-end -o wide</span><br><span class="line">参考官方文档，按照需要 edit deployment，添加端口信息</span><br><span class="line">kubectl edit deployment front-end</span><br><span class="line">#注意 :set paste，防止 yaml 文件空格错序。</span><br><span class="line"> spec:</span><br><span class="line">   containers:</span><br><span class="line">   - image: vicuu/nginx:hello</span><br><span class="line">     imagePullPolicy: IfNotPresent</span><br><span class="line">     name: nginx #找到此位置。下文会简单说明一下 yaml 文件的格式，不懂 yaml 格式的，往下看。</span><br><span class="line">     ports: #添加这 4 行</span><br><span class="line">     - name: http</span><br><span class="line">       containerPort: 80</span><br><span class="line">       protocol: TCP</span><br></pre></td></tr></table></figure>
<p>暴露对应端口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl expose deployment front-end --type=NodePort --port=80 --target-port=80 --name=front-end-svc</span><br><span class="line">#注意考试中需要创建的是 NodePort，还是 ClusterIP。如果是 ClusterIP，则应为--type=ClusterIP</span><br><span class="line">#--port 是 service 的端口号，--target-port 是 deployment 里 pod 的容器的端口号。</span><br></pre></td></tr></table></figure>
<p>暴露服务后，检查一下 service 的 selector 标签是否正确，这个要与 deployment 的 selector 标签一致的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc front-end-svc -o wide</span><br><span class="line">kubectl get deployment front-end -o wide</span><br></pre></td></tr></table></figure>
<p>如果你 kubectl expose 暴露服务后，发现 service 的 selector 标签是空的<none>，或者不是 deployment 的。<br>则需要编辑此 service，手动添加标签。（模拟环境里暴露服务后，selector 标签是正确的。但是考试时，有时 service 的 selector 标签是 none）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit svc front-end-svc</span><br><span class="line">在 ports 这一小段下面添加 selector 标签</span><br><span class="line"> selector:</span><br><span class="line"> app: front-end #注意 yaml 里是写冒号，而不是等号，不是 app=front-end。</span><br></pre></td></tr></table></figure>
<p>确保 service 的 selector 标签与 deployment 的 selector 标签一致。<br>最后 curl 检查 kubectl get pod,svc -o wide<br>curl 所在的 node 的 ip 或主机名:30938<br>curl svc 的 ip 地址:80<br>（注意，只能 curl 通 svc 的 80 端口，但是无法 ping 通的。）<br>考试时，如果 curl 不通，简单排错后也不通，就不要过于纠结，继续往下做题即可。因为部分同学反馈 curl 不通，不清楚是否为考试集群环境的问题。 只要确保都做对了，即使 curl 不通，也最多扣几分而已，是有其他步骤分的。</p>
<h3 id="5、创建-Ingress"><a href="#5、创建-Ingress" class="headerlink" title="5、创建 Ingress"></a>5、创建 Ingress</h3><p>设置配置环境： [candidate@node-1] $ kubectl config use-context k8s<br><strong>Task</strong><br>如下创建一个新的 nginx Ingress 资源：<br>名称: <strong>ping</strong><br>Namespace: <strong>ing-internal</strong><br>使用服务端口 <strong>5678</strong> 在路径 <strong>&#x2F;hello</strong> 上公开服务 <strong>hello</strong><br>可以使用以下命令检查服务 <strong>hello</strong> 的可用性，该命令应返回 <strong>hello</strong>：<br>curl -kL <INTERNAL_IP>&#x2F;hello<br>考点：Ingress 的创建<br>依次点击 Concepts → Services, Load Balancing, and Networking → Ingress </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">vim ingress.yaml</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: IngressClass</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/component: controller</span><br><span class="line">  name: nginx-example</span><br><span class="line">  annotations:</span><br><span class="line">    ingressclass.kubernetes.io/is-default-class: &quot;true&quot;</span><br><span class="line">spec:</span><br><span class="line">  controller: k8s.io/ingress-nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: ping</span><br><span class="line">  namespace: ing-internal</span><br><span class="line">  annotations:</span><br><span class="line">    nginx.ingress.kubernetes.io/rewrite-target: /</span><br><span class="line">spec:</span><br><span class="line">  ingressClassName: nginx-example</span><br><span class="line">  rules:</span><br><span class="line">  - http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /hello</span><br><span class="line">        pathType: Prefix</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: hello</span><br><span class="line">            port:</span><br><span class="line">              number: 5678</span><br><span class="line">创建</span><br><span class="line">kubectl apply -f ingress.yaml</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">最后 curl 检查</span><br><span class="line"># 通过 get ingress 查看 ingress 的内外 IP，然后通过提供的 curl 测试 ingress 是否正确。</span><br><span class="line"># 做完题后，略等 3 分钟，再检查，否则可能还没获取 IP 地址。或者可以先去做别的题，等都做完了，再回来检查这道题，一下，记得回来检查时，先使用 kubectl </span><br><span class="line">config use-context k8s 切换到此集群。</span><br><span class="line">kubectl get ingress -n ing-internal</span><br><span class="line">curl ingress 的 ip 地址/hello</span><br></pre></td></tr></table></figure>
<h3 id="6、扩容-deployment-副本数量"><a href="#6、扩容-deployment-副本数量" class="headerlink" title="6、扩容 deployment 副本数量"></a>6、扩容 deployment 副本数量</h3><p>设置配置环境： [candidate@node-1] $ kubectl config use-context k8s<br><strong>Task</strong><br>将 deployment <strong>presentation</strong> 扩展至 <strong>4</strong> 个 pods<br>kubectl scale deployment -h</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">扩展成 4 个</span><br><span class="line">kubectl scale deployment presentation --replicas=4</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">candidate@node01:~$ kubectl get deployments presentation -o wide</span><br><span class="line">NAME           READY   UP-TO-DATE   AVAILABLE   AGE    CONTAINERS   IMAGES              SELECTOR</span><br><span class="line">presentation   4/4     4            4           251d   nginx        vicuu/nginx:hello   app=presentation</span><br><span class="line">candidate@node01:~$ kubectl get pod -l app=presentation</span><br><span class="line">NAME                           READY   STATUS    RESTARTS      AGE</span><br><span class="line">presentation-78777866b-8v7p5   1/1     Running   0             39s</span><br><span class="line">presentation-78777866b-dvpm9   1/1     Running   0             39s</span><br><span class="line">presentation-78777866b-lbvk2   1/1     Running   0             39s</span><br><span class="line">presentation-78777866b-n855j   1/1     Running   4 (63m ago)   251d</span><br></pre></td></tr></table></figure>
<h3 id="7、调度-pod-到指定节点"><a href="#7、调度-pod-到指定节点" class="headerlink" title="7、调度 pod 到指定节点"></a>7、调度 pod 到指定节点</h3><p>设置配置环境： [candidate@node-1] $ kubectl config use-context k8s<br><strong>Task</strong><br>按如下要求调度一个 pod：<br>名称：<strong>nginx-kusc00401</strong><br>Image：<strong>nginx</strong><br>Node selector：<strong>disk&#x3D;ssd</strong><br>依次点击 Tasks → Configure Pods and Containers → Assign Pods to Nodes</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes --show-labels|grep &#x27;disk=ssd&#x27;</span><br><span class="line">kubectl label nodes node01 disk=ssd</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">vim pod-disk-ssd.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-kusc00401</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx</span><br><span class="line">    image: nginx</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">  nodeSelector:</span><br><span class="line">    disk: ssd</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f pod-disk-ssd.yaml</span><br><span class="line">candidate@node01:~$ kubectl get pod nginx-kusc00401 -o wide</span><br><span class="line">NAME              READY   STATUS    RESTARTS   AGE   IP               NODE     NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-kusc00401   1/1     Running   0          6s    10.244.196.182   node01   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<h3 id="8、查看可用节点数量"><a href="#8、查看可用节点数量" class="headerlink" title="8、查看可用节点数量"></a>8、查看可用节点数量</h3><p>设置配置环境： [candidate@node-1] $ kubectl config use-context k8s<br><strong>Task</strong><br>检查有多少 nodes 已准备就绪（不包括被打上 Taint：<strong>NoSchedule</strong> 的节点），<br>并将数量写入 <strong>&#x2F;opt&#x2F;KUSC00402&#x2F;kusc00402.txt</strong><br>kubectl -h</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">candidate@node01:~$ kubectl describe nodes |grep -i Taint |grep -vc NoSchedule</span><br><span class="line">2</span><br><span class="line">candidate@node01:~$ echo &quot;2&quot; &gt; /opt/KUSC00402/kusc00402.txt</span><br></pre></td></tr></table></figure>
<h3 id="9、创建多容器的-pod"><a href="#9、创建多容器的-pod" class="headerlink" title="9、创建多容器的 pod"></a>9、创建多容器的 pod</h3><p>设置配置环境： [candidate@node-1] $ kubectl config use-context k8s<br><strong>Task</strong><br>按如下要求调度一个 Pod：<br>名称：<strong>kucc8</strong><br>app containers: <strong>2</strong><br>container 名称&#x2F;images： </p>
<ul>
<li><strong>nginx</strong></li>
<li><strong>consul</strong></li>
</ul>
<p>依次点击 Concepts → Workloads → Pods</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: kucc8</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx</span><br><span class="line">    image: nginx</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">  - name: consul</span><br><span class="line">    image: consul</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f pod-kucc.yaml</span><br><span class="line">kubectl get pod kucc8</span><br></pre></td></tr></table></figure>
<h3 id="10、创建-PV"><a href="#10、创建-PV" class="headerlink" title="10、创建 PV"></a>10、创建 PV</h3><p>设置配置环境： [candidate@node-1] $ kubectl config use-context hk8s<br><strong>Task</strong><br>创建名为 <strong>app-config</strong> 的 <strong>persistent volume</strong>，容量为 <strong>1Gi</strong>，<br>访问模式为 <strong>ReadWriteMany</strong>。 volume 类型为 <strong>hostPath</strong>，位于 <strong>&#x2F;srv&#x2F;app-config</strong><br>依次点击 Tasks → Configure Pods and Containers → Configure a Pod to Use a PersistentVolume for Storage</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">vim pv.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: app-config</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 1Gi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  hostPath:</span><br><span class="line">    path: &quot;/srv/app-config&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">candidate@node01:~$ kubectl apply -f pv.yaml </span><br><span class="line">persistentvolume/app-config created</span><br><span class="line">candidate@node01:~$ kubectl get pv</span><br><span class="line">app-config</span><br></pre></td></tr></table></figure>
<h3 id="11、创建-PVC"><a href="#11、创建-PVC" class="headerlink" title="11、创建 PVC"></a>11、创建 PVC</h3><p>设置配置环境： [candidate@node-1] $ kubectl config use-context ok8s<br><strong>Task</strong><br>创建一个新的 <strong>PersistentVolumeClaim</strong>：<br>名称: <strong>pv-volume</strong><br>Class: <strong>csi-hostpath-sc</strong><br>容量: <strong>10Mi</strong><br>创建一个新的 Pod，来将 <strong>PersistentVolumeClaim</strong> 作为 volume 进行挂载：<br>名称：<strong>web-server</strong><br>Image：<strong>nginx:1.16</strong><br>挂载路径：**&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html**<br>配置新的 Pod，以对 volume 具有 <strong>ReadWriteOnce</strong> 权限。<br>最后，使用 <strong>kubectl edit</strong> 或 <strong>kubectl patch</strong> 将 <strong>PersistentVolumeClaim</strong> 的容量扩展为 <strong>70Mi，并记录此更改。</strong><br>依次点击 Tasks → Configure Pods and Containers → Configure a Pod to Use a PersistentVolume for Storage</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">vim pvc.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: pv-volume</span><br><span class="line">spec:</span><br><span class="line">  storageClassName: csi-hostpath-sc</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 10Mi</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f pvc.yaml</span><br><span class="line">kubectl get pvc</span><br><span class="line">pv-volume   Bound</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">vim pvc-pod.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: web-server</span><br><span class="line">spec:</span><br><span class="line">  volumes:</span><br><span class="line">    - name: task-pv-storage</span><br><span class="line">      persistentVolumeClaim:</span><br><span class="line">        claimName: pv-volume</span><br><span class="line">  containers:</span><br><span class="line">    - name: nginx</span><br><span class="line">      image: nginx:1.16</span><br><span class="line">      volumeMounts:</span><br><span class="line">        - mountPath: &quot;/usr/share/nginx/html&quot;</span><br><span class="line">          name: task-pv-storage</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f pvc-pod.yaml </span><br><span class="line">kubectl get pod web-server</span><br><span class="line">web-server   1/1     Running</span><br></pre></td></tr></table></figure>
<p>将 storage: 10Mi 改为 storage: 70Mi<br>kubectl edit pvc pv-volume –record</p>
<h3 id="12、查看-pod-日志"><a href="#12、查看-pod-日志" class="headerlink" title="12、查看 pod 日志"></a>12、查看 pod 日志</h3><p>设置配置环境： [candidate@node-1] $ kubectl config use-context k8s<br><strong>Task</strong><br>监控 pod <strong>foo</strong> 的日志并：<br>提取与错误 <strong>RLIMIT_NOFILE</strong> 相对应的日志行<br>将这些日志行写入 <strong>&#x2F;opt&#x2F;KUTR00101&#x2F;foo</strong><br>kubectl logs foo |grep “RLIMIT_NOFILE” &gt; &#x2F;opt&#x2F;KUTR00101&#x2F;foocat &#x2F;opt&#x2F;KUTR00101&#x2F;foo</p>
<h3 id="13、使用-sidecar-代理容器日志"><a href="#13、使用-sidecar-代理容器日志" class="headerlink" title="13、使用 sidecar 代理容器日志"></a>13、使用 sidecar 代理容器日志</h3><p>设置配置环境： [candidate@node-1] $ kubectl config use-context k8s<br><strong>Context</strong><br>将一个现有的 Pod 集成到 Kubernetes 的内置日志记录体系结构中（例如 kubectl logs）。<br>添加 streaming sidecar 容器是实现此要求的一种好方法。<br><strong>Task</strong><br>使用 <strong>busybox</strong> Image 来将名为 <strong>sidecar</strong> 的 sidecar 容器添加到现有的 Pod <strong>11-factor-app</strong> 中。<br>新的 sidecar 容器必须运行以下命令：<br><strong>&#x2F;bin&#x2F;sh -c tail -n+1 -f &#x2F;var&#x2F;log&#x2F;11-factor-app.log</strong><br>使用挂载在**&#x2F;var&#x2F;log** 的 Volume，使日志文件 <strong>11-factor-app.log</strong> 可用于 sidecar 容器。<br>除了添加所需要的 volume mount 以外，请勿更改现有容器的规格。<br>依次点击 Concepts → Cluster Administration → Logging Architecture</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod 11-factor-app -o yaml &gt; varlog.yaml</span><br><span class="line">cp varlog.yaml varlog-bak.yaml </span><br><span class="line">vim varlog.yaml</span><br><span class="line">    - mountPath: /var/run/secrets/kubernetes.io/serviceaccount</span><br><span class="line">      name: kube-api-access-xhzsg</span><br><span class="line">      readOnly: true</span><br><span class="line">    - name: varlog</span><br><span class="line">      mountPath: /var/log</span><br><span class="line">  - name: sidecar</span><br><span class="line">    image: busybox</span><br><span class="line">    args: [/bin/sh, -c, &#x27;tail -n+1 -F /var/log/11-factor-app.log&#x27;]</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: varlog</span><br><span class="line">      mountPath: /var/log</span><br><span class="line">  dnsPolicy: ClusterFirst</span><br><span class="line">...</span><br><span class="line">  - name: varlog</span><br><span class="line">    emptyDir: &#123;&#125;         </span><br><span class="line">status:</span><br><span class="line">  conditions:</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 删除原先的 pod</span><br><span class="line">kubectl delete pod 11-factor-app</span><br><span class="line">kubectl get pod 11-factor-app</span><br><span class="line"># 新建这个 pod</span><br><span class="line">kubectl apply -f varlog.yaml</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f varlog.yaml </span><br><span class="line">kubectl get pod 11-factor-app</span><br><span class="line">kubectl logs 11-factor-app sidecar</span><br></pre></td></tr></table></figure>
<h3 id="14、升级集群"><a href="#14、升级集群" class="headerlink" title="14、升级集群"></a>14、升级集群</h3><p>设置配置环境： [candidate@node-1] $ kubectl config use-context mk8s<br><strong>Task</strong><br>现有的 Kubernetes 集群正在运行版本 <strong>1.29.1</strong>。<strong>仅将 master 节点</strong>上的所有 Kubernetes 控制平面和节点组件升级到版本 <strong>1.29.2</strong>。<br>确保在升级之前 drain master 节点，并在升级后 uncordon master 节点。<br>可以使用以下命令，通过 ssh 连接到 master 节点： ssh master01 可<br>以使用以下命令，在该 master 节点上获取更高权限： sudo -i<br>另外，在主节点上升级 <strong>kubelet</strong> 和 <strong>kubectl</strong>。 请不要升级工作节点，etcd，container 管理器，CNI 插件， DNS 服务或任何其他插件。<br>（注意，考试敲命令时，注意要升级的版本，根据题目要求输入具体的升级版本！！！）<br>依次点击 Tasks → Administer a Cluster → Administration with kubeadm → Upgrading kubeadm clusters </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes</span><br><span class="line">kubectl cordon master01     ##cordon 停止调度</span><br><span class="line">kubectl drain master01 --ignore-daemonsets  ##drain 驱逐节点</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># ssh 到 master 节点，并切换到 root 下</span><br><span class="line">ssh master01</span><br><span class="line">sudo -i</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apt-get update</span><br><span class="line">apt-cache show kubeadm|grep 1.29.2</span><br><span class="line">apt-get install kubeadm=1.29.2-00</span><br><span class="line">kubeadm version</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 验证升级计划，会显示很多可升级的版本，我们关注题目要求升级到的那个版本。</span><br><span class="line">kubeadm upgrade plan</span><br><span class="line"># 排除 etcd，升级其他的，提示时，输入 y。</span><br><span class="line">kubeadm upgrade apply v1.29.2 --etcd-upgrade=false</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">升级 kubelet</span><br><span class="line">apt-get install kubelet=1.29.2-00</span><br><span class="line">kubelet --version</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">升级 kubectl</span><br><span class="line">apt-get install kubectl=1.29.2-00</span><br><span class="line">kubectl version</span><br></pre></td></tr></table></figure>
<p>exit exit</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl uncordon master01 ##恢复 master01 调度</span><br><span class="line">kubectl get node</span><br></pre></td></tr></table></figure>
<h3 id="15、备份还原-etcd"><a href="#15、备份还原-etcd" class="headerlink" title="15、备份还原 etcd"></a>15、备份还原 etcd</h3><p>设置配置环境 此项目无需更改配置环境。<br>但是，在执行此项目之前，请确保您已返回初始节点。<br>[candidate@master01] $ exit #注意，这个之前是在 master01 上，所以要 exit 退到 node01，如果已经是 node01 了，就不要再 exit 了。<br><strong>Task</strong><br>首先，为运行在 <a target="_blank" rel="noopener" href="https://11.0.1.111:2379/">https://11.0.1.111:2379</a> 上的现有 <strong>etcd</strong> 实例创建快照并将快照保存到 <strong>&#x2F;var&#x2F;lib&#x2F;backup&#x2F;etcd-snapshot.db</strong> （注意，真实考试中，这里写的是 <a target="_blank" rel="noopener" href="https://127.0.0.1:2379/">https://127.0.0.1:2379</a>）<br>为给定实例创建快照预计能在几秒钟内完成。 如果该操作似乎挂起，则命令可能有问题。用 CTRL + C 来取消操作，然后重试。 然后还原位于**&#x2F;data&#x2F;backup&#x2F;etcd-snapshot-previous.db** 的现有先前快照。<br>提供了以下 TLS 证书和密钥，以通过 etcdctl 连接到服务器。<br>CA 证书: &#x2F;opt&#x2F;KUIN00601&#x2F;ca.crt<br>客户端证书: &#x2F;opt&#x2F;KUIN00601&#x2F;etcd-client.crt<br>客户端密钥: &#x2F;opt&#x2F;KUIN00601&#x2F;etcd-client.key<br>export ETCDCTL_API&#x3D;3etcdctl -h</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">etcdctl --endpoints=https://11.0.1.111:2379 --cacert=&quot;/opt/KUIN00601/ca.crt&quot; --cert=&quot;/opt/KUIN00601/etcd-client.crt&quot; --key=&quot;/opt/KUIN00601/etcd-client.key&quot; snapshot save /var/lib/backup/etcd-snapshot.db</span><br><span class="line"></span><br><span class="line">Snapshot saved at /var/lib/backup/etcd-snapshot.db</span><br></pre></td></tr></table></figure>
<p>etcdctl snapshot status &#x2F;var&#x2F;lib&#x2F;backup&#x2F;etcd-snapshot.db -wtable #检查</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo ETCDCTL_API=3 etcdctl --endpoints=https://11.0.1.111:2379 --cacert=&quot;/opt/KUIN00601/ca.crt&quot; --cert=&quot;/opt/KUIN00601/etcd-client.crt&quot; --key=&quot;/opt/KUIN00601/etcd-client.key&quot; snapshot restore /data/backup/etcd-snapshot-previous.db</span><br><span class="line"></span><br><span class="line">restored snapshot        &#123;&quot;path&quot;: &quot;/data/backup/etcd-snapshot-previous.db&quot;,</span><br></pre></td></tr></table></figure>
<h3 id="16、排查集群中故障节点"><a href="#16、排查集群中故障节点" class="headerlink" title="16、排查集群中故障节点"></a>16、排查集群中故障节点</h3><p>设置配置环境： [candidate@node-1] $ kubectl config use-context wk8s<br><strong>Task</strong><br>名为 <strong>node02</strong> 的 Kubernetes worker node 处于 <strong>NotReady</strong> 状态。<br>调查发生这种情况的原因，并采取相应的措施将 node 恢复为 <strong>Ready</strong> 状态，确保所做的任何更改<strong>永久生效</strong>。<br>可以使用以下命令，通过 ssh 连接到 node02 节点： ssh node02<br>可以使用以下命令，在该节点上获取更高权限： sudo -i<br>记住先 restart 再 enable 就行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">在 candidate@node01 上执行模拟环境</span><br><span class="line">sudo sh /opt/sh/a.sh</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes</span><br><span class="line">node02     NotReady</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh node02</span><br><span class="line">sudo -i</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl status kubelet</span><br><span class="line">systemctl start kubelet</span><br><span class="line">systemctl enable kubelet</span><br><span class="line">systemctl status kubelet</span><br></pre></td></tr></table></figure>
<p>exit exit</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes</span><br><span class="line">node02     Ready</span><br></pre></td></tr></table></figure>
<h3 id="17、节点维护"><a href="#17、节点维护" class="headerlink" title="17、节点维护"></a>17、节点维护</h3><p>设置配置环境： [candidate@node-1] $ kubectl config use-context ek8s<br><strong>Task</strong><br>将名为 node02 的 node 设置为不可用，并重新调度该 node 上所有运行的 pods。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl -h</span><br><span class="line">kubectl drain -h</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node</span><br><span class="line">kubectl cordon node02</span><br><span class="line">kubectl get node</span><br></pre></td></tr></table></figure>
<p>kubectl drain node02 –ignore-daemonsets –delete-emptydir-data –force</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node</span><br><span class="line">kubectl get pod -A -o wide|grep node02</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://example.com">keli</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2024/08/12/CKA/">http://example.com/2024/08/12/CKA/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">颗粒的运维手册</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/kubernetes%E8%80%83%E8%AF%95/">kubernetes考试</a></div><div class="post_share"><div class="social-share" data-image="/img/avatar.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/08/12/English/" title="15篇文章吃透四级单词"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">15篇文章吃透四级单词</div></div></a></div><div class="next-post pull-right"><a href="/2024/08/12/ClickHouse_start/" title="ClickHouse快速上手"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">ClickHouse快速上手</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2024/08/12/CKS/" title="CKS考试"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-12</div><div class="title">CKS考试</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">keli</div><div class="author-info__description">运维手记</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">19</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">17</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">练习时长两年半</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6-RBAC"><span class="toc-text">1、权限控制 RBAC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E6%9F%A5%E7%9C%8B-pod-%E7%9A%84-CPU"><span class="toc-text">2、查看 pod 的 CPU</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E9%85%8D%E7%BD%AE%E7%BD%91%E7%BB%9C%E7%AD%96%E7%95%A5-NetworkPolicy"><span class="toc-text">3、配置网络策略 NetworkPolicy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E6%9A%B4%E9%9C%B2%E6%9C%8D%E5%8A%A1-service"><span class="toc-text">4、暴露服务 service</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E5%88%9B%E5%BB%BA-Ingress"><span class="toc-text">5、创建 Ingress</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81%E6%89%A9%E5%AE%B9-deployment-%E5%89%AF%E6%9C%AC%E6%95%B0%E9%87%8F"><span class="toc-text">6、扩容 deployment 副本数量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7%E3%80%81%E8%B0%83%E5%BA%A6-pod-%E5%88%B0%E6%8C%87%E5%AE%9A%E8%8A%82%E7%82%B9"><span class="toc-text">7、调度 pod 到指定节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8%E3%80%81%E6%9F%A5%E7%9C%8B%E5%8F%AF%E7%94%A8%E8%8A%82%E7%82%B9%E6%95%B0%E9%87%8F"><span class="toc-text">8、查看可用节点数量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9%E3%80%81%E5%88%9B%E5%BB%BA%E5%A4%9A%E5%AE%B9%E5%99%A8%E7%9A%84-pod"><span class="toc-text">9、创建多容器的 pod</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10%E3%80%81%E5%88%9B%E5%BB%BA-PV"><span class="toc-text">10、创建 PV</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11%E3%80%81%E5%88%9B%E5%BB%BA-PVC"><span class="toc-text">11、创建 PVC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12%E3%80%81%E6%9F%A5%E7%9C%8B-pod-%E6%97%A5%E5%BF%97"><span class="toc-text">12、查看 pod 日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13%E3%80%81%E4%BD%BF%E7%94%A8-sidecar-%E4%BB%A3%E7%90%86%E5%AE%B9%E5%99%A8%E6%97%A5%E5%BF%97"><span class="toc-text">13、使用 sidecar 代理容器日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14%E3%80%81%E5%8D%87%E7%BA%A7%E9%9B%86%E7%BE%A4"><span class="toc-text">14、升级集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15%E3%80%81%E5%A4%87%E4%BB%BD%E8%BF%98%E5%8E%9F-etcd"><span class="toc-text">15、备份还原 etcd</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#16%E3%80%81%E6%8E%92%E6%9F%A5%E9%9B%86%E7%BE%A4%E4%B8%AD%E6%95%85%E9%9A%9C%E8%8A%82%E7%82%B9"><span class="toc-text">16、排查集群中故障节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#17%E3%80%81%E8%8A%82%E7%82%B9%E7%BB%B4%E6%8A%A4"><span class="toc-text">17、节点维护</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/12/MySQL_install/" title="MySQL 8.0的三种安装方式">MySQL 8.0的三种安装方式</a><time datetime="2024-08-12T02:26:28.014Z" title="发表于 2024-08-12 10:26:28">2024-08-12</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/12/superset_install/" title="superset部署与实践">superset部署与实践</a><time datetime="2024-08-12T02:26:28.014Z" title="发表于 2024-08-12 10:26:28">2024-08-12</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/12/python_50/" title="python编程50例">python编程50例</a><time datetime="2024-08-12T02:26:28.014Z" title="发表于 2024-08-12 10:26:28">2024-08-12</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/12/superset_pk_metabase/" title="superset与metabase调研比较">superset与metabase调研比较</a><time datetime="2024-08-12T02:26:28.014Z" title="发表于 2024-08-12 10:26:28">2024-08-12</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/12/python_spider_new/" title="Python实时爬虫：自动抓取并推送学校最新通知">Python实时爬虫：自动抓取并推送学校最新通知</a><time datetime="2024-08-12T02:26:28.014Z" title="发表于 2024-08-12 10:26:28">2024-08-12</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By keli</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="true"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.13.0"></script></div></div></body></html>